stages:
  - build
  - publish

build_electron:
  stage: build
  image: node:20
  script:
    # Bước 1: Install dependencies cho Electron (root)
    - npm ci

    # Bước 2: Build Vue app
    - cd vibe-app

    - npm pkg set scripts.postinstall="echo 'Skipping postinstall in CI'"

    - npm install --prefer-offline --no-audit --include=dev

    # Set NODE_ENV for the build process only
    - NODE_ENV=production npm run build
    - cd ..

    # Bước 3: Compile TypeScript (Electron main process)
    - npx tsc

    # Bước 4: Build Electron app (chỉ Linux vì đang chạy trên Linux runner)
    # Note: macOS build cần macOS runner, Windows build cần Wine hoặc Windows runner
    - npx electron-builder --linux
  artifacts:
    paths:
      - dist/*.AppImage
      - dist/*.deb
      - dist/*.rpm
      - dist/*.snap
    expire_in: 1 week

publish_release:
  stage: publish
  image: node:20
  dependencies:
    - build_electron
  script:
    - npx electron-builder --publish always
  only:
    - main
