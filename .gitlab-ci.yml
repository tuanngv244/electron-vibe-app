stages:
  - build
  - publish

variables:
  NODE_ENV: production

build_electron:
  stage: build
  image: node:20
  script:
    # Install root dependencies (electron, electron-builder, etc.)
    - npm ci

    # Build Vue app
    - cd vibe-app
    - npm ci --ignore-scripts
    - npm run build:icons
    - npm run msw:init
    - npm run build
    - cd ..

    # Compile TypeScript (main process)
    - npx tsc

    # Build Electron app for all platforms
    - npx electron-builder --win --mac --linux
  artifacts:
    paths:
      - dist/**/*
    expire_in: 1 week

publish_release:
  stage: publish
  image: node:20
  dependencies:
    - build_electron
  script:
    - npm ci
    - npx electron-builder --publish always
  only:
    - main
