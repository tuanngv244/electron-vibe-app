stages:
  - build
  - publish

variables:
  NODE_ENV: production

build_electron:
  stage: build
  image: node:20
  script:
    # Bước 1: Install dependencies cho Electron (root)
    - npm ci

    # Bước 2: Build Vue app
    - cd vibe-app
    # Skip postinstall scripts (icons/msw not needed for production)
    - npm pkg set scripts.postinstall="echo 'Skipping postinstall in CI'"
    # Install all dependencies (handles missing package-lock.json gracefully)
    - npm install --prefer-offline --no-audit
    - npm run build
    - cd ..

    # Bước 3: Compile TypeScript (Electron main process)
    - npx tsc

    # Bước 4: Build Electron app (đóng gói tất cả)
    - npx electron-builder --win --mac --linux
  artifacts:
    paths:
      - dist/*.exe
      - dist/*.dmg
      - dist/*.AppImage
      - dist/*.deb
      - dist/*.rpm
    expire_in: 1 week

publish_release:
  stage: publish
  image: node:20
  dependencies:
    - build_electron
  script:
    - npx electron-builder --publish always
  only:
    - main
